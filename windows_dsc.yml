---
- name: PowerShell DSC
  hosts: "win2025"
  gather_facts: true

  tasks:
    - name: Setup PsGallery
      ansible.windows.win_powershell:
        script: |
          $nuget_version = (Get-PackageProvider -Name NuGet -ListAvailable).version
          $nuget_target_version = [Version]::new('2.8.5.201')
          if( $nuget_version -lt $nuget_target_version ){
            [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
            Install-PackageProvider -Name NuGet -MinimumVersion $nuget_target_version -Force
            Install-Module -Name packagemanagement -Force
            Install-Module -Name powershellget -Force
          }

    - name: Setup the SecurityPolicyDSC module
      community.windows.win_psmodule:
        name: SecurityPolicyDSC
        module_version: 2.10.0.0
        state: present
        accept_license: true

    - name: Set password history
      ansible.windows.win_dsc:
        resource_name: AccountPolicy
        Name: Enforce_password_history
        Enforce_password_history: 24

    - name: Set maximum password age
      ansible.windows.win_dsc:
        resource_name: AccountPolicy
        Name: Maximum_Password_Age
        Maximum_Password_Age: 60

    - name: Set minimum password age
      ansible.windows.win_dsc:
        resource_name: AccountPolicy
        Name: Minimum_Password_Age
        Minimum_Password_Age: 20

    - name: Set minimum password length
      ansible.windows.win_dsc:
        resource_name: AccountPolicy
        Name: Minimum_Password_Length
        minimum_Password_Length: 8

    - name: Set password complexity requirements
      ansible.windows.win_dsc:
        resource_name: AccountPolicy
        Name: Password_must_meet_complexity_requirements
        Password_must_meet_complexity_requirements: Enabled

    - name: Export current security policy
      ansible.windows.win_shell: secedit /export /cfg C:\Windows\Temp\ansible_secpol.inf
      changed_when: false # This command doesn't change state

    - name: 1. Export current security policy to a temporary file
      ansible.windows.win_shell: secedit /export /cfg C:\Windows\Temp\ansible_secpol_verify.inf
      changed_when: false # This command is read-only, so we tell Ansible it never changes anything
      args:
        executable: cmd.exe # Ensure this runs in the standard command shell

    - name: 2. Read the content of the exported policy file
      ansible.windows.slurp:
        src: C:\Windows\Temp\ansible_secpol_verify.inf
      register: secpol_file

    - name: 3. Decode the policy file content for parsing
      ansible.builtin.set_fact:
        secpol_content: "{{ secpol_file['content'] | b64decode }}"

    - name: 4. Display the effective password policies
      ansible.builtin.debug:
        msg:
          - "------------------------------------------------------------"
          - " Password Policy Report for: {{ inventory_hostname }} "
          - "------------------------------------------------------------"
          - "Enforce password history:   {{ secpol_content | regex_search('PasswordHistorySize = (\\d+)', '\\1') | first | default('Not Set') }} passwords remembered"
          - "Maximum password age:       {{ secpol_content | regex_search('MaximumPasswordAge = (\\d+)', '\\1') | first | default('Not Set') }} days"
          - "Minimum password age:       {{ secpol_content | regex_search('MinimumPasswordAge = (\\d+)', '\\1') | first | default('Not Set') }} days"
          - "Minimum password length:    {{ secpol_content | regex_search('MinimumPasswordLength = (\\d+)', '\\1') | first | default('Not Set') }} characters"
          - "Complexity enabled:         {{ 'Yes' if 'PasswordComplexity = 1' in secpol_content else 'No' }}"
          - "------------------------------------------------------------"

    - name: 5. Clean up the temporary policy file
      ansible.windows.win_file:
        path: C:\Windows\Temp\ansible_secpol_verify.inf
        state: absent